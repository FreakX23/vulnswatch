<div class="container">

<% if @couch_db_down || @couch_db_busy %>

  <img src="<%= asset_path("wait#{rand(1..6)}.gif") %>" style="margin: auto; display: block; width: 60%; margin-bottom: 3em;">

  <% if @couch_db_down %>

  <% if @couch_exception && @couch_exception.results %>

<p class="alert alert-warning">
        Seems that Couch DB is very busy at the moment, please,
       give it a moment or two and try again. 
</p>

    <% else %>

    <p class="alert alert-warning">
    Couch DB seems to be down or very busy. 
      Please, try again in a minute, and then contact the administrator
      if it is still not working.
        </p>
    <% end %>
  
  <% elsif @couch_db_busy %>
    
    
      <div class="container"> Couch DB is busy indexing at the moment. Please, come back in a minute. </div>
    



    <% @couch_status[:details].each do |process| %>
      <div class="container alert alert-info">
        <%= "Indexer started on #{process[:started_on].to_s(:time)} is now at #{process[:progress]}%" %>
      </div>
    <% end %>

  <% end %>

<% else %>
<% pager = will_paginate %>
<% @explanations = RelevantVulnerability.explanator(@vulnerabilities, current_user) %> 

<%= pager%>

<%= form_tag vulnerabilities_path, method: :get, class: 'search', id: 'search_form' do  %>
 
 <%= text_field_tag :search, 
   params[:search], id: "vulnerabilities_search", 
   class: "form-control short-search", placeholder: "Search in names, components or summary" %>
 
 <%= submit_tag 'Search', class: 'search-button btn btn-primary' %>
 
 <%= link_to 'Clear',\
       '#', class: 'btn reset-search-btn',\
       onclick: "$('#vulnerabilities_search')[0].value = ''; $('#search_form').submit();" %>

           
<%= render 'shared/last_update_nvd' %>

<table id="vulns" class="index_table table-striped">
  <thead>
    <tr>
      <th><%= sorting_link_to 'Name', 'name' %></th>
      
      <th><%= sorting_link_to 'Updated', 'modified' %>
      </th>
      
      <th>Component</th>
      
      <th title='Focus on a field, or click an icon in the next column to learn more.'>Summary</th>
      <th title='' colspan=3>Read more details on</th>
      <th title='Select a project.

Estimated affected component in a project.'>Project</th>

      <th><%= sorting_link_to 'Reaction', 'reaction' %>


      </th>
    </tr>
  </thead>
  
  <tbody>

  <tr class='filters'>
  
    <td><%= text_field_tag :name, params[:name], id: "name_filter", placeholder: 'CVE-2017-',  class: "form-control table-search"%> </td>
  
    <td></td>
  
    <td>
      <%= text_field_tag :component, params[:component], id: "component_filter", placeholder: 'e.g. BSD',  class: "form-control table-search"%>
    </td>
  
    <td>
      <%= text_field_tag :summary, params[:summary], id: "summary_filter", placeholder: 'e.g. Apache 2',  class: "form-control table-search"%>
    </td>
  
    <td colspan=3></td>
  
  <td>

      <%= select_tag :project,\
                  options_for_select(projects_filter_collection, params[:project]),\
                  id: "project_filter",\
                  include_blank: true,\
                  onchange: "this.form.submit();",\
                  class: "form-control table-search"
                %>

  </td>
  <td>
         <%= select_tag :reaction,\
                  options_for_select(explanations_collection_short, params[:reaction].to_i),\
                  id: "reaction_filter",\
                  include_blank: true,\
                  onchange: "this.form.submit();",\
                  class: "form-control table-search"
                %>

  </td>
  </tr>
  

<% if @vulnerabilities.count == 0 %>

</tbody>
</table>


<p class='alert alert-notice'>No vulnerabilities were found.<br>
Try to relax the search criteria, update vulnerabilities
or add more systems to your projects.</p>


<% else %>

    <% @vulnerabilities.each do |vulnerability| %>
      <tr>
        <td><%= link_to_vulnerability vulnerability %></td>
        <td><%= ago_helper(vulnerability.modified) %></td>
        <td class="component">
          <%= render 'shared/component', vulnerability: vulnerability %>
        </td>
        <td class='vulnerability-summary'><%= link_to shorten(vulnerability.summary, 88), vulnerability, title: vulnerability.summary, 
                 class: 'black_text_link' %></td>
        <td><%= link_to_nvd(vulnerability) %></td>
        <td><%= link_to_cve_details(vulnerability) %></td>
        <td><%= link_to_google(vulnerability) %></td>
        <td class="relevance"><%= render('explanations', explanation: @explanations[vulnerability] )%></td>
        <td class="status">
           <%= link_to_react(vulnerability) %>            
        </td>
      </tr>
    <% end %>
  </tbody>
</table>


<%= pager %>





<br>
<br>
<br>
<%= link_to "Show Relevant Vulnerabilities", relevant_vulnerabilities_path, class: 'btn btn-primary'%>

<% end %>
<br>
<br>

<p>
  <%= reaction_legend.html_safe %>
</p>



<% end %>

</div>

<% end %>