class Vulnerability < ApplicationRecord
  require 'open-uri'
  require 'zip'
  require 'nokogiri'
  require 'date'

  def self.get_nvd_url_for_year(year)
    "https://static.nvd.nist.gov/feeds/xml/cve/2.0/nvdcve-2.0-#{year}.xml.zip"
  end

  def self.load_vulnerabilities_from_nvd_for_year(year)
    update_from_nvd_zip(get_nvd_url_for_year(year))
  end
  
  def self.get_nvd_update_url()
    "https://static.nvd.nist.gov/feeds/xml/cve/2.0/nvdcve-2.0-modified.xml.zip"
  end

  def self.load_zip_content(httpsaddress)
    begin
      zip_file = Zip::File.open(open(httpsaddress))
      content = zip_file.first.get_input_stream.read
      return content
    rescue => exception
      logger.warn "Exception when loading CVEs from #{httpsaddress}: " + "#{exception.class.to_s + " " + exception.to_s}"
      return ""
    end
  end

  def self.load_new_vulnerabilities_from_nvd()
    update_from_nvd_zip(get_nvd_update_url())
  end
  
  def self.update_from_nvd_zip(httpsaddress)
    content = load_zip_content(httpsaddress)
  end
end
