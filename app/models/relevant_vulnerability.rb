require 'set'

class RelevantVulnerability # Non ActiveRecord

  def self.users_systems(user)
    all_projects = user.projects

    systems = Set.new
    
    all_projects.each do |project|
      systems.merge(project.systems)
    end
    
    systems.to_a
  end

  def self.vulnerability_affects_system?(vulnerability, system)
    return false if vulnerability.nil? or vulnerability.summary.nil? or vulnerability.summary.empty?
    return false if system.nil? or system.empty?
    return system == vulnerability.affected_system unless vulnerability.affected_system.nil?
    return vulnerability.summary.downcase =~ /\W#{system.downcase}\W/
  end

  def self.relevant_vulnerabilities(user)
    systems = users_systems(user)
    return Vulnerability.none if systems.empty?

    conditions =['']
    systems.each do |system|
      newpart = 'summary LIKE ?'
      conditions[0] =  conditions[0].empty? ? newpart : conditions[0] + ' OR ' + newpart
      conditions.push "%#{system}%"
    end    
    
    first_fetch = Vulnerability.where(conditions).order(modified: :desc)
    vulns = []
    first_fetch.each do |v|
      vulns.push(v) if systems.any? { |sys| vulnerability_affects_system?(v, sys) }
    end
    vulns
  end

  def self.affected_systems(vulnerability, user)
    systems = RelevantVulnerability.users_systems(user)
    res = []
    systems.each do |system|
      res.push system if vulnerability_affects_system?(vulnerability, system)
    end
    res
  end

  def self.projects_having_system(system, user)
    res = []
    user.projects.each do |project|
      res.push project if project.systems.include? system
    end
    res
  end


end

