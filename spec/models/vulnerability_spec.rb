require 'rails_helper'
require 'spec_helper'

RSpec.describe Vulnerability, type: :model do

  def expect_valid_nvd_url(url) 
    expect(url).to end_with("zip")
    expect(url).to start_with("https://")
    expect(url).to include("nvd.nist.gov")
  end

  describe ".get_nvd_url_for_year" do 
    it "returns valid url" do
      url = Vulnerability.get_nvd_url_for_year(2017)
      expect_valid_nvd_url(url)
      expect(url).to include("2017")
    end
  end  

  describe ".get_nvd_update_url" do 
    it "returns valid update url" do
      url = Vulnerability.get_nvd_update_url()
      expect_valid_nvd_url(url)
    end
  end  
  
  describe ".load_zip_content" do
    it "returns valid xml content for update" do
      content = Vulnerability.load_zip_content(Vulnerability.get_nvd_update_url())
      expect(content).to start_with("<?xml version='1.0' encoding='UTF-8'?>")
      expect(content).to end_with("</nvd>")
    end
  end

  describe ".load_zip_content" do
    it "returns valid xml content for year 2017" do
      content = Vulnerability.load_zip_content(Vulnerability.get_nvd_url_for_year(2017))
      expect(content).to start_with("<?xml version='1.0' encoding='UTF-8'?>")
      expect(content).to end_with("</nvd>")
    end
  end

  describe ".load_zip_content" do
    it "returns no content for invalid year" do
      content = Vulnerability.load_zip_content(Vulnerability.get_nvd_url_for_year(1980))
      expect(content).to be_empty
    end
  end

end
